on:
  push:
    tags:
      - '*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup Variables
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "MAJOR=${TAG%%.*}" >> $GITHUB_ENV
          echo "MAJOR_MINOR=${TAG%.*}" >> $GITHUB_ENV
          echo "SEMVER=${TAG}" >> $GITHUB_ENV
          echo "SHORT_SHA=${GITHUB_SHA::8}" >> $GITHUB_ENV

      - name: Build Image
        id: build-image
        uses: redhat-actions/buildah-build@v2
        with:
          image: alpine-wget
          tags: latest ${{ env.MAJOR }} ${{ env.MAJOR_MINOR }} ${{ env.SEMVER }} ${{ env.SHORT_SHA }}
          oci: true
          dockerfiles: ./Containerfile

      - name: Publish Image to ghcr.io
        uses: redhat-actions/push-to-registry@v2
        with:
          image: ${{ steps.build-image.outputs.image }}
          tags: ${{ steps.build-image.outputs.tags }}
          registry: ghcr.io/${{ github.repository_owner }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Publish Image to quay.io
        uses: redhat-actions/push-to-registry@v2
        with:
          image: ${{ steps.build-image.outputs.image }}
          tags: ${{ steps.build-image.outputs.tags }}
          registry: quay.io/k3rnel-pan1c
          username: k3rnel-pan1c+github_actions
          password: ${{ secrets.RH_TOKEN }}

      - name: Publish Image to docker.io
        uses: redhat-actions/push-to-registry@v2
        with:
          image: ${{ steps.build-image.outputs.image }}
          tags: ${{ steps.build-image.outputs.tags }}
          registry: docker.io/k3rnelpan1c
          username: k3rnelpan1c
          password: ${{ secrets.DH_TOKEN }}
